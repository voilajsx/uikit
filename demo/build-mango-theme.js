#!/usr/bin/env node

/**
 * Demo theme bundler - generates Mango theme CSS for demo only
 * @file demo/build-mango-theme.js
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

/**
 * Generate CSS for a single theme
 */
function generateThemeCSS(theme) {
  if (!theme || !theme.id || !theme.light || !theme.dark) {
    console.warn(`âš ï¸  Invalid theme structure`);
    return '';
  }

  // Generate enhanced design tokens if available
  let enhancedTokens = '';
  if (theme.design) {
    const designTokens = Object.entries(theme.design)
      .map(([key, value]) => {
        const cssKey = `--voila-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
        return `  ${cssKey}: ${value};`;
      })
      .join('\n');
    
    if (designTokens) {
      enhancedTokens = `\n  /* ðŸš€ Enhanced Design Tokens */\n${designTokens}`;
    }
  }

  const lightVariables = Object.entries(theme.light)
    .map(([key, value]) => {
      const cssKey = `--color-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
      return `  ${cssKey}: ${value};`;
    })
    .join('\n');

  const darkVariables = Object.entries(theme.dark)
    .map(([key, value]) => {
      const cssKey = `--color-${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
      return `  ${cssKey}: ${value};`;
    })
    .join('\n');

  return `/* ${theme.name} Theme */
.theme-${theme.id} {${enhancedTokens}
  /* Color Variables */
${lightVariables}
}

.theme-${theme.id}.dark {
  /* Color Variables */
${darkVariables}
}`;
}

async function main() {
  console.log('ðŸ¥­ Building Mango theme CSS for demo...\n');

  try {
    // Import the mango theme
    const mangoModule = await import('./src/themes/mango.js');
    const mangoTheme = mangoModule.default;

    // Generate CSS
    const themeCSS = generateThemeCSS(mangoTheme);

    if (!themeCSS) {
      console.log('âŒ No valid CSS generated');
      return false;
    }

    // Create the complete CSS file content
    const finalContent = `/*
 * ðŸ¥­ Mango Theme for Demo - Generated by demo theme bundler
 * 
 * Auto-generated CSS for Mango theme only
 * Generated: ${new Date().toISOString()}
 * 
 * DO NOT EDIT THIS FILE DIRECTLY
 * Edit demo/src/themes/mango.js and run "node demo/build-mango-theme.js" to regenerate
 */

${themeCSS}
`;

    // Write the file
    const outputPath = path.resolve(__dirname, 'src/styles/mango-theme.css');
    const outputDir = path.dirname(outputPath);

    // Ensure output directory exists
    if (!fs.existsSync(outputDir)) {
      fs.mkdirSync(outputDir, { recursive: true });
    }

    fs.writeFileSync(outputPath, finalContent);

    console.log(`âœ… Successfully generated Mango theme CSS`);
    console.log(`ðŸ“¦ Output: ${outputPath}`);
    console.log(`ðŸ“„ Size: ${(finalContent.length / 1024).toFixed(1)}kb`);
    console.log(`\nðŸ’¡ Import in your app: import './styles/mango-theme.css'`);

    return true;
  } catch (err) {
    console.error('âŒ Build failed:', err.message);
    return false;
  }
}

// Run the build
main().catch((err) => {
  console.error('ðŸ’¥ Unexpected error:', err);
  process.exit(1);
});